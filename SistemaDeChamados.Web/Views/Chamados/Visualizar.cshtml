@using System.Web.Optimization
@model SistemaDeChamados.Application.ViewModels.VisualizarChamadoVM

@Styles.Render("~/bundles/chamados")

<div class="col-sm-6">

    <div class="col-xs-12">
        <h2>@Model.Titulo</h2>
        <p>
            Lorem ipsum dolor sit amet, consectetur adipiscing elit. Duis pharetra varius quam sit amet vulputate.
            Quisque mauris augue, molestie tincidunt condimentum vitae, gravida a libero. Aenean sit amet felis
            dolor, in sagittis nisi. Sed ac orci quis tortor imperdiet venenatis. Duis elementum auctor accumsan.
            Aliquam in felis sit amet augue. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Duis pharetra varius quam sit amet vulputate.
            Quisque mauris augue, molestie tincidunt condimentum vitae, gravida a libero. Aenean sit amet felis
            dolor, in sagittis nisi. Sed ac orci quis tortor imperdiet venenatis. Duis elementum auctor accumsan.
            Aliquam in felis sit amet augue. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Duis pharetra varius quam sit amet vulputate.
            Quisque mauris augue, molestie tincidunt condimentum vitae, gravida a libero. Aenean sit amet felis
            dolor, in sagittis nisi. Sed ac orci quis tortor imperdiet venenatis. Duis elementum auctor accumsan.
            Aliquam in felis sit amet augue. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Duis pharetra varius quam sit amet vulputate.
            Quisque mauris augue, molestie tincidunt condimentum vitae, gravida a libero. Aenean sit amet felis
            dolor, in sagittis nisi. Sed ac orci quis tortor imperdiet venenatis. Duis elementum auctor accumsan.
            Aliquam in felis sit amet augue.
        </p>
        <ul class="list-inline">
            <li>
                <a href="#">@Model.DataDeCriacao</a>
            </li>
            <li>
                <a href="#"><i class="glyphicon glyphicon-comment"></i> 2 Mensagens</a>
            </li>
            <li>
                Criado por: @Model.NomeColaborador
            </li>
        </ul>
    </div>
</div>
<div class="col-sm-5">
    <div class="div-chamado-actions">
        <div class="btn-group" role="group" aria-label="...">
            <button type="button" class="btn btn-default dropdown-toggle btn-custom-dropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <i class="fa fa-pencil-square-o"></i> <span class="caret"></span>
            </button>
            <ul class="dropdown-menu">
                <li><a href="#">Aberto<i class="glyphicon glyphicon-ok icon-chamado-status"></i></a></li>
                <li><a href="#">Suspenso</a></li>
                <li><a href="#">Resolvido</a></li>
                <li><a href="#">Não reproduzido</a></li>
            </ul>
            <button type="button" class="btn btn-danger"><i class="fa fa-times"></i></button>
            <button type="button" class="btn btn-success" data-toggle="modal" data-target="#mensagemModal"><i class="fa fa-envelope"></i></button>
            <button type="button" class="btn btn-warning">Encerrar</button>

        </div>
    </div>
    <div class="panel panel-default" style="margin-top: 10px;">
        <div class="panel-heading">Anexos do Chamado</div>
        <div class="panel-body">
            <table class="table">
                <tbody>
                    <tr>
                        @foreach (var anexo in @Model.Arquivos)
                        {
                            <td><a href="@Url.Action("DownloadAnexo", "Chamados")">@anexo.Filename</a></td>
                        }
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <div class="panel panel-default" style="margin-top: 10px;">
        <div class="panel-heading">
            Últimas mensagens <a style="float: right">Ver todas</a>
        </div>
        <div class="panel-body" id="panelMsg" style="overflow-y: scroll; height: 300px">
            @Html.ListaDeMensagemDoChamado(Model.Mensagens, Model.ColaboradorId, Model.NomeColaborador, Model.NomeAnalista)
        </div>
    </div>

</div>

<div>
    <div class="modal fade" id="mensagemModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">Nova Mensagem</h4>
                </div>
                <form class="novaMensagemForm">
                    @Html.HiddenFor(model => model.NovaMensagem.ChamadoId, new { id = "chamadoID" })
                    <div class="modal-body">
                        @Html.TextAreaFor(model => model.NovaMensagem.Texto, new { @class = "textarea-mensagem" })
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Fechar</button>
                        <button type="button" class="btn btn-primary btn-send">Enviar<i class="fa fa-spinner fa-spin" style="margin-left: 10px"></i></button>
                    </div>
                </form>

            </div>
        </div>
    </div>
</div>

<style>
    .btn-custom-dropdown {
        -ms-border-radius: 0;
        border-radius: 0;
        -ms-border-top-left-radius: 5px;
        border-top-left-radius: 5px;
        -ms-border-bottom-left-radius: 5px;
        border-bottom-left-radius: 5px;
    }

    .div-chamado-actions {
        margin-top: 25px;
        margin-left: 70px
    }

    .icon-chamado-status {
        margin-left: 5px
    }

    .text-center {
        text-align: center;
    }

    .identificacao-usuario {
        font-size: 8pt;
    }

    .identificacao-usuario > span {
        font-weight: bold;
    }

    .textarea-mensagem {
        width: 500px;
        height: 200px;
    }
</style>

<script>
    $(function () {

        var loadingSpinner = $('.fa-spinner');
        loadingSpinner.hide();
        var modalMensagem = $('#mensagemModal');

        var novaMensagem = {
            ChamadoId: "",
            Texto: "",
            NomeUsuario: ""
        };

       modalMensagem.on('shown.bs.modal', function () {
            $('#myInput').focus();
        });

        function fecharModal() {
            modalMensagem.modal('hide');
            $('#mensagemModal textarea').val('');
        }

        function exibirLoading() {
            $('.btn-send').prop('disabled', true);
            loadingSpinner.show();
        }

        $('.btn-send').click(function () {
            exibirLoading();

            novaMensagem.ChamadoId = $('#chamadoID').val();
            novaMensagem.Texto = $('.textarea-mensagem').val();
            $.ajax({
                type: "POST",
                url: window.location.origin + "/Chamados/NovaMensagem",
                data: novaMensagem,
                statusCode: {
                    200: function (data) {

                        var listadeMsg = $('.list-group');
                        if (listadeMsg.length === 0) {
                            $('.text-center').first().remove();
                            $('#panelMsg').append('<ul class=\"list-group\">');
                        }

                        loadingSpinner.hide();
                        listadeMsg.append('<li class=\"list-group-item\">' + data.Texto + '<ul class=\"list-inline\"> <li class=\"identificacao-usuario\">Por: <span>' + data.NomeUsuario + '</span></li></ul></li>');
                        fecharModal();
                    }
                }
            });
        });
    });
</script>


